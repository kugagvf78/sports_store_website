document.addEventListener("DOMContentLoaded",function(){const t=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content"),s=document.querySelectorAll(".thumbnail-image, .thumbnail"),r=document.querySelector(".product-main-image, #main-image");s.forEach(function(e){e.addEventListener("click",function(){r&&(r.style.opacity="0.7",setTimeout(()=>{r.src=this.dataset.large||this.src,r.style.opacity="1"},150),s.forEach(o=>{o.classList.remove("border-red-500","scale-105"),o.classList.add("border-gray-300")}),this.classList.add("border-red-500","scale-105"),this.classList.remove("border-gray-300"))})});const n=document.getElementById("quantity-input"),d=document.getElementById("decrease-qty"),i=document.getElementById("increase-qty");d&&d.addEventListener("click",function(){const e=parseInt(n.value);e>1&&(n.value=e-1)}),i&&i.addEventListener("click",function(){const e=parseInt(n.value);n.value=e+1});const l=document.querySelector(".add-to-cart-btn, #add-to-cart");l&&l.addEventListener("click",function(){const e=document.getElementById("selected-variant-id"),o=e?e.value:l.dataset.variantId||null;if(document.querySelectorAll(".select-variant-btn, tbody button").length>0&&!o){a("Vui lòng chọn phiên bản sản phẩm trước khi thêm vào giỏ hàng","error");return}const g=n?n.value:1,u=this.querySelector("i"),x=this.innerHTML;this.disabled=!0,this.classList.add("opacity-75","cursor-not-allowed"),u&&(u.classList.remove("fa-shopping-cart"),u.classList.add("fa-spinner","fa-spin")),this.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Đang thêm...',fetch("/cart/add",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":t,Accept:"application/json"},body:JSON.stringify({product_variant_id:o,quantity:parseInt(g)})}).then(h=>{if(h.status===401)throw new Error("unauthorized");return h.ok?h.json():h.json().then(b=>{throw new Error(b.message||"Có lỗi xảy ra")})}).then(h=>{u&&(u.classList.remove("fa-spinner","fa-spin"),u.classList.add("fa-check")),this.innerHTML='<i class="fas fa-check mr-2"></i>Đã thêm vào giỏ hàng',this.classList.remove("opacity-75","bg-red-600","hover:bg-red-700"),this.classList.add("bg-green-600","hover:bg-green-700"),N(),h.message&&a(h.message,"success"),setTimeout(()=>{this.innerHTML=x,this.disabled=!1,this.classList.remove("opacity-75","cursor-not-allowed","bg-green-600","hover:bg-green-700"),this.classList.add("bg-red-600","hover:bg-red-700")},2e3)}).catch(h=>{this.innerHTML=x,this.disabled=!1,this.classList.remove("opacity-75","cursor-not-allowed"),h.message==="unauthorized"?confirm("Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng. Chuyển đến trang đăng nhập?")&&(window.location.href="/login"):a(h.message||"Có lỗi xảy ra. Vui lòng thử lại!","error")})});const c=document.querySelector(".copy-link-btn");c&&c.addEventListener("click",function(){const e=this.querySelector("i"),o=e.className;navigator.clipboard.writeText(window.location.href).then(()=>{e.className="fas fa-check text-green-600",a("Đã sao chép link!","success"),setTimeout(()=>{e.className=o},1500)}).catch(m=>{console.error("Could not copy text: ",m);const g=document.createElement("textarea");g.value=window.location.href,document.body.appendChild(g),g.select();try{document.execCommand("copy"),e.className="fas fa-check text-green-600",a("Đã sao chép link!","success"),setTimeout(()=>{e.className=o},1500)}catch(u){console.error("Fallback: Oops, unable to copy",u),a("Không thể sao chép link","error")}document.body.removeChild(g)})});const f=document.querySelectorAll(".select-variant-btn, tbody button"),v=document.getElementById("selected-variant-id"),L=document.getElementById("price-value");f.forEach(e=>{e.addEventListener("click",function(){const o=this.getAttribute("data-variant-id"),m=this.getAttribute("data-price");v&&o&&(v.value=o);const g=this.closest("tr");let u=m;!u&&g&&(g.querySelector("td:first-child")?.textContent.trim(),u=g.querySelector("td:nth-child(4)")?.textContent.trim());const x=document.querySelector(".text-3xl.font-bold.text-red-600");x&&u&&(L?L.textContent=new Intl.NumberFormat("vi-VN").format(u)+" VND":x.innerHTML=`<i class="fas fa-tag mr-2"></i>${u}`);const h=this.innerHTML;this.innerHTML='<i class="fas fa-check mr-1"></i>Đã chọn',this.classList.remove("border-red-600","text-red-600","hover:bg-red-600","hover:text-white"),this.classList.add("bg-green-600","text-white","border-green-600"),f.forEach(b=>{b!==this&&(b.innerHTML='<i class="fas fa-cart-plus mr-1"></i>Chọn',b.classList.remove("bg-green-600","text-white","border-green-600"),b.classList.add("border-red-600","text-red-600","hover:bg-red-600","hover:text-white"))}),setTimeout(()=>{this.innerHTML=h,this.classList.remove("bg-green-600","text-white","border-green-600"),this.classList.add("border-red-600","text-red-600","hover:bg-red-600","hover:text-white")},2e3)})});const y=document.querySelector("h5:has(i.fa-list)");y&&new IntersectionObserver(o=>{o.forEach(m=>{m.isIntersecting&&m.target.classList.add("animate-fade-in")})},{threshold:.1}).observe(y.parentElement),r&&(r.addEventListener("mouseenter",function(){this.style.cursor="zoom-in"}),r.addEventListener("mouseleave",function(){this.style.cursor="default"})),document.querySelectorAll('[title*="Chia sẻ"]').forEach(e=>{e.addEventListener("click",function(){const o=this.querySelector("i"),m=o.className;o.className="fas fa-spinner fa-spin",setTimeout(()=>{o.className=m},1e3)})});let E=null,S=null;const C=document.querySelectorAll(".color-btn"),T=document.querySelectorAll(".size-btn"),k=document.getElementById("stock-info"),w=document.getElementById("add-to-cart");C.forEach(e=>{e.addEventListener("click",()=>{C.forEach(o=>o.classList.remove("border-red-500","bg-red-50")),e.classList.add("border-red-500","bg-red-50"),E=e.dataset.color,q()})}),T.forEach(e=>{e.addEventListener("click",()=>{T.forEach(o=>o.classList.remove("border-red-500","bg-red-50")),e.classList.add("border-red-500","bg-red-50"),S=e.dataset.size,q()})});function q(){!E||!S||fetch(`/product/${window.productId}/variant?color=${E}&size=${S}`).then(e=>e.json()).then(e=>{if(console.log("Variant data:",e),e&&e.stock!==void 0){k.textContent=e.stock>0?`Còn ${e.stock} sản phẩm`:"Hết hàng",w.disabled=e.stock<=0,w.dataset.variantId=e.id;const o=document.querySelector(".text-3xl.font-bold.text-red-600");if(o&&e.price){const m=Number(e.price).toLocaleString("vi-VN",{minimumFractionDigits:0,maximumFractionDigits:0});o.innerHTML=`<i class="fas fa-tag mr-2"></i>${m} VND`}}else k.textContent="Không tìm thấy loại hàng này",w.disabled=!0}).catch(e=>{console.error("Fetch error:",e),k.textContent="Lỗi khi tải dữ liệu",w.disabled=!0})}});document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelectorAll("[data-target]"),s=document.querySelectorAll(".tab-pane");t.forEach(r=>{r.addEventListener("click",()=>{t.forEach(d=>{d.classList.remove("text-red-600","border-red-600","border-b-2","font-semibold"),d.classList.add("text-gray-600")}),s.forEach(d=>d.classList.add("hidden")),r.classList.remove("text-gray-600"),r.classList.add("text-red-600","border-red-600","border-b-2","font-semibold");const n=document.querySelector(r.dataset.target);n&&n.classList.remove("hidden")})})});document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector('form[action*="reviews"]'),s=document.querySelectorAll(".star-btn"),r=document.getElementById("rating"),n=document.querySelector('meta[name="csrf-token"]'),d=n?n.content:null;s.length>0&&r&&s.forEach((i,l)=>{i.addEventListener("click",()=>{const c=i.dataset.value;r.value=c,s.forEach(f=>f.classList.remove("text-yellow-400"));for(let f=0;f<=l;f++)s[f].classList.add("text-yellow-400")}),i.addEventListener("mouseenter",()=>{s.forEach(c=>c.classList.remove("text-yellow-300"));for(let c=0;c<=l;c++)s[c].classList.add("text-yellow-300")}),i.addEventListener("mouseleave",()=>{s.forEach(c=>c.classList.remove("text-yellow-300"))})}),t&&d&&t.addEventListener("submit",async function(i){i.preventDefault();const l=new FormData(t),c=t.querySelector('button[type="submit"]'),f=c.innerHTML,v=()=>{c.disabled=!1,c.innerHTML=f,typeof window.toggleLoadingSpinner=="function"&&window.toggleLoadingSpinner(!1)},L=setTimeout(()=>{v(),a("Yêu cầu quá lâu, vui lòng thử lại.","error")},8e3);try{a("Đang gửi đánh giá...","info"),c.disabled=!0,c.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Đang gửi...';const y=await fetch(t.action,{method:"POST",headers:{"X-CSRF-TOKEN":d,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:l});clearTimeout(L);let p={};try{p=await y.json()}catch{v(),a("Phản hồi không hợp lệ từ máy chủ.","error");return}if(!y.ok){v(),a(p.message||"Không thể gửi đánh giá","error");return}v(),p.success?(a(p.message||"Gửi đánh giá thành công!","success"),setTimeout(()=>location.reload(),1500)):a(p.message||"Không thể gửi đánh giá","error")}catch(y){clearTimeout(L),console.error("Review submission error:",y),v(),a("Đã xảy ra lỗi khi gửi đánh giá.","error")}})});function N(){fetch("/cart/count").then(t=>t.json()).then(t=>{const s=document.getElementById("cartCount");s&&(s.textContent=t.count,s.classList.add("scale-125"),setTimeout(()=>{s.classList.remove("scale-125")},300))}).catch(t=>console.error("Error updating cart count:",t))}function a(t,s="info"){const r=document.querySelector(".notification-toast");r&&r.remove();const n=document.createElement("div");n.className=`notification-toast fixed top-20 right-4 px-6 py-4 rounded-2xl shadow-lg border z-50 transition-all duration-300 transform translate-x-0 bg-white ${s==="success"?"border-green-400 text-green-700":s==="error"?"border-red-400 text-red-700":"border-blue-400 text-blue-700"}`,n.innerHTML=`
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <i class="fas ${s==="success"?"fa-check-circle text-green-500":s==="error"?"fa-exclamation-circle text-red-500":"fa-info-circle text-blue-500"} text-2xl"></i>
            </div>
            <div class="flex-1">
                <p class="font-medium">${t}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 ml-3 hover:opacity-80">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `,document.body.appendChild(n),setTimeout(()=>{n.classList.add("translate-x-0")},10),setTimeout(()=>{n.style.transform="translateX(400px)",n.style.opacity="0",setTimeout(()=>{document.body.contains(n)&&document.body.removeChild(n)},300)},4e3)}function I(t){document.querySelectorAll(".wishlist-count").forEach(r=>{r.textContent=t,r.classList.add("scale-125"),setTimeout(()=>{r.classList.remove("scale-125")},300)})}document.addEventListener("DOMContentLoaded",()=>{const t=document.querySelector("#wishlist-btn"),s=document.querySelector('meta[name="csrf-token"]')?.content;t&&s&&t.addEventListener("click",async function(){const r=this.dataset.productId,n=this.querySelector("i");try{const i=await(await fetch("/wishlist/toggle",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":s,Accept:"application/json"},body:JSON.stringify({product_id:r})})).json();if(i.success){if(i.isInWishlist){n.classList.remove("far"),n.classList.add("fas","text-white"),this.classList.remove("border-red-600","text-red-600","hover:bg-red-600","hover:text-white"),this.classList.add("bg-red-600","text-white","border-red-600");const l=this.querySelector("span");l&&(l.textContent="Đã yêu thích"),a("Đã thêm vào danh sách yêu thích!","success")}else{n.classList.remove("fas","text-white"),n.classList.add("far","text-red-600"),this.classList.remove("bg-red-600","text-white"),this.classList.add("border-red-600","text-red-600","hover:bg-red-600","hover:text-white");const l=this.querySelector("span");l&&(l.textContent="Yêu thích"),a("Đã xóa khỏi danh sách yêu thích!","info")}typeof I=="function"&&I(i.wishlistCount)}else i.redirect?(a(i.message,"error"),setTimeout(()=>{window.location.href=i.redirect},1500)):a(i.message||"Không thể xử lý yêu thích","error")}catch(d){console.error(d),a("Có lỗi xảy ra, vui lòng thử lại.","error")}})});document.addEventListener("DOMContentLoaded",async()=>{const t=document.querySelector("#wishlist-btn"),s=t?.querySelector("i"),r=t?.querySelector("span"),n=document.querySelector('meta[name="csrf-token"]')?.content;if(!(!t||!n||!window.productId))try{(await(await fetch("/wishlist/check",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n},body:JSON.stringify({product_id:window.productId})})).json()).isInWishlist?(s.classList.remove("far"),s.classList.add("fas","text-white"),t.classList.remove("border-red-600","text-red-600","hover:bg-red-600","hover:text-white"),t.classList.add("bg-red-600","text-white","border-red-600"),r.textContent="Đã yêu thích"):(s.classList.remove("fas","text-white"),s.classList.add("far","text-red-600"),t.classList.remove("bg-red-600","text-white"),t.classList.add("border-red-600","text-red-600","hover:bg-red-600","hover:text-white"),r.textContent="Yêu thích")}catch(d){console.error("Lỗi khi kiểm tra trạng thái wishlist:",d)}});
